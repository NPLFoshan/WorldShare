<html>
    <body>
        <pe:mcml>
            <script type='text/npl'>
                <![CDATA[
                    -- helper
                    local Validated = NPL.load('(gl)Mod/WorldShare/helper/Validated.lua')

                    -- UI
                    local RegisterModal = NPL.load('(gl)Mod/WorldShare/cellar/RegisterModal/RegisterModal.lua')

                    -- service
                    local KeepworkServiceSession = NPL.load('(gl)Mod/WorldShare/service/KeepworkService/KeepworkServiceSession.lua')

                    local page = document:GetPageCtrl()
    
                    local mode = page:GetRequestParam('mode')

                    canClose = true

                    if mode == 'summer' then
                        canClose = false
                    end

                    isClickedGetPhoneCaptcha = false

                    function close()
                        if page.certificateCallback and type(page.certificateCallback) == 'function' then
                            page.certificateCallback()
                        end

                        page:CloseWindow()
                    end

                    function bind()
                        GameLogic.GetFilters():apply_filters('user_behavior', 1, 'click.world.certificate.bind')

                        local phonenumber = page:GetValue('phonenumber')
                        local phonecaptcha = page:GetValue('phonecaptcha')

                        if not phonenumber or not Validated:Phone(phonenumber) then
                            GameLogic.AddBBS(nil, L'手机格式错误', 3000, '255 0 0')
                            return false
                        end

                        if not phonecaptcha or #phonecaptcha == 0 then
                            GameLogic.AddBBS(nil, L'手机验证码格式错误', 3000, '255 0 0')
                            return false
                        end

                        -- only classification
                        Mod.WorldShare.MsgBox:Wait()
                        RegisterModal:Classification(phonenumber, phonecaptcha, function(data)
                            KeepworkServiceSession:CheckVerify()
                            Mod.WorldShare.MsgBox:Close()
                            close()
                        end, true)
                    end

                    function check_phone_number(callback)
                        local phonenumber = page:GetValue('phonenumber')

                        if not phonenumber or
                        type(phonenumber) ~= 'string' or
                        #phonenumber == 0  then
                            return
                        end

                        KeepworkServiceSession:CheckPhonenumberExist(phonenumber, function(bIsExist)
                            if bIsExist then
                                page:SetValue('is_bind', false)

                                if page.callback and
                                callback and
                                type(callback) == 'function' then
                                    callback(false)
                                end
                            end
                        end)
                    end

                    function get_phone_captcha()
                        GameLogic.GetFilters():apply_filters('user_behavior', 1, 'click.world.certificate.get_phone_captcha')

                        if not Validated:Phone(page:GetValue('phonenumber')) then
                            GameLogic.AddBBS(nil, L'手机格式错误', 3000, '255 0 0')
                            return false
                        end

                        if isClickedGetPhoneCaptcha then
                            return false 
                        end

                        isClickedGetPhoneCaptcha = true

                        local times = 60

                        local timer = commonlib.Timer:new({
                            callbackFunc = function(timer)
                                page:SetValue('getPhoneCaptcha', format('%s(%ds)', L'重新发送', times))

                                if times == 0 then
                                    isClickedGetPhoneCaptcha = false
                                    page:SetValue('getPhoneCaptcha', L'获取验证码')
                                    timer:Change(nil, nil)
                                end

                                times = times - 1
                            end
                        })

                        KeepworkServiceSession:GetPhoneCaptcha(page:GetValue('phonenumber'), function(data, err)
                            if err ~= 200 then
                                isClickedGetPhoneCaptcha = false
                                page:SetValue('getPhoneCaptcha', L'获取验证码')
                                GameLogic.AddBBS(nil, format('%s%s(%d)', L'发送验证码失败，错误信息：', data.message or '', data.code or 0), 5000, '255 0 0')
                                timer:Change(nil, nil)
                            end
                        end)

                        timer:Change(1000, 1000)
                    end

                    function get_background_width()
                        local Screen = System.Windows.Screen
                        local width = Screen:GetWidth()
                        Screen:PushDesignResolution(1280, 720)

                        return (width - 255)
                    end

                    function get_background_height()
                        local Screen = System.Windows.Screen
                        local height = Screen:GetHeight()

                        return (height - 93)
                    end

                    function checkRealName()
                        KeepworkServiceSession:Profile(function(data, err)
                            if err ~= 200 or
                            not data or
                            type(data) ~= 'table' then
                                return  
                            end

                            if data.realname then
                                if page.Success and type(page.Success) == 'function' then
                                    if page and page.Success then
                                        page.Success()
                                    end

                                    Mod.WorldShare.MsgBox:Close()
                                    page:CloseWindow()
                                end
                            else
                                Mod.WorldShare.Utils.SetTimeOut(function()
                                    if page.closed then
                                        return
                                    end

                                    checkRealName()
                                end, 1500)
                            end
                        end, Mod.WorldShare.Store:Get('user/token'))
                    end

                    checkRealName()
                ]]>
            </script>
            <style type='text/mscc' src='Mod/WorldShare/cellar/Theme/Mcss/Theme1.mcss'>
                {
                    theme1_text_editor = {
                        background = 'Texture/Aries/Creator/keepwork/Certification/zi_shurudi_32X32_32bits.png#0 0 32 32:8 8 8 8',
                        textcolor = '#000000',
                        ['font-size'] = 20,
                    },
                    theme1_myhome_green_bt = {
                        background = 'Texture/Aries/Creator/keepwork/Certification/btn_lv_32X32_32bits.png#0 0 32 32:8 8 8 8',
                        textcolor = '#000000',
                    },
                    
                    theme1_myhome_blue_bt = {
                        background = 'Texture/Aries/Creator/keepwork/Certification/btn_lan_32X32_32bits.png#0 0 32 32:8 8 8 8',
                        width = 104,
                        height = 32,
                        folat = 'left',
                    },

                    theme1_myhome_gray_bt = {
                        background = 'Texture/Aries/Creator/keepwork/Certification/btn_hs_32X32_32bits.png#0 0 32 32:8 8 8 8',
                        width = 104,
                        height = 32,
                        folat = 'left',
                    },
                }
            </style>
            <pe:if condition='<%= canClose %>'>
                <div width='100%' height='100%' style='position: relative;background: url();'>
                </div>
            </pe:if>
            <pe:if condition='<%= not canClose %>'>
                <pe:container
                    width='<%= get_background_width() %>'
                    height='100%'
                    style='background-color: #00000099;
                        position: relative;'>
                </pe:container>
                <pe:container
                    alignment='_rb'
                    width='255'
                    height='<%= get_background_height() %>'
                    style='background-color: #00000099;
                        position: relative;'>
                </pe:container>
            </pe:if>
            <pe:container
                alignment='_ct'
                width='760'
                height='490'
                style='background: url();
                    margin-top: -245px;
                    margin-left: -380px;'>
                <kp:window
                    width='760'
                    height='490'
                    onclose='close()'
                    is_hide_close='<%= not canClose %>'>
                    <img style='position: relative;
                                width: 97px;
                                height: 25px;
                                margin-left: 15px;
                                margin-top: 7px;'
                        src='Texture/Aries/Creator/keepwork/Certification/shiming_97X25_32bits.png#0 0 97 25' />
                    <div class='theme1_header'></div>
                    <div style='padding: 10px;
                                padding-top: 40px;'>
                        <div align='center'
                             style='width: 525px;
                                    height: 40px;
                                    padding-top: 8px;
                                    text-align: center;
                                    background: url(Texture/Aries/Creator/keepwork/Certification/tu1_469X40_32bits.png#0 0 469 40);'>
                            输入家长手机号发送认证短信，并提醒家长点击认证链接，即可完成实名认证。
                        </div>
                        <div align='center'
                             style='width: 469px;
                                    height: 40px;
                                    margin-top: 8px;
                                    text-align: center;'>
                            完成实名认证后， 你创造的世界才能被别人看到哦。
                        </div>
                        <div style='font-size: 18px;
                                    base-font-size: 18px;
                                    margin-left: 148px;
                                    margin-top: 5px;'>
                            <img style='width: 53px;height: 17px;margin-top: 9px;'
                                src='Texture/Aries/Creator/keepwork/Certification/zi_shoujihao_53X17_32bits.png#0 0 53 17' />
                            <input type='text'
                                style='width: 375px;height: 34px;margin-left: 15px;'
                                class='theme1_text_editor'
                                onfocusout='check_phone_number()'
                                name='phonenumber' />
                        </div>
                        <pe:if condition='<%= canClose %>'>
                            <div align='center'
                                 style='margin-top: 18px;
                                        width: 312px'>
                                <input type='button'
                                       style='width: 128px;
                                              height: 45px;
                                              float: left;
                                              text-offset-y: -2;
                                              background: url(Texture/Aries/Creator/paracraft/fasong_128x45_32bits.png#0 0 128 45)'
                                       value='<%= L"发送短信" %>'
                                    onclick='bind()' />
                                <input type='button'
                                    style='margin-left: 56px;
                                           width: 128px;
                                           height: 45px;
                                           float: left;
                                           text-offset-y: -2;
                                           background: url(Texture/Aries/Creator/paracraft/tiaoguo_128x45_32bits.png#0 0 128 45)'
                                    value='<%= L"跳过" %>'
                                    onclick='close()' />
                            </div>
                        </pe:if>
                        <pe:if condition='<%= not canClose %>'>
                            <div align='center'
                                 style='margin-top: 18px;
                                        width: 312px'>
                                <input type='button'
                                       style='width: 128px;
                                              height: 45px;
                                              float: left;
                                              text-offset-y: -2;
                                              background: url(Texture/Aries/Creator/paracraft/fasong_128x45_32bits.png#0 0 128 45)'
                                       value='<%= L"发送短信" %>'
                                    onclick='bind()' />
                            </div>
                        </pe:if>
                        <div align='center'
                            style='width: 420px;
                                    height: 161px;
                                    margin-top: 15px;'>
                            <img style='width: 420px;
                                        height: 161px;'
                                src='Texture/Aries/Creator/paracraft/jiangli2_420x161_32bits.png#0 0 420 161' />
                        </div>
                    </div>
                </kp:window>
            </pe:container>
        </pe:mcml>
    </body>
</html>
